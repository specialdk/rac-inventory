<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Account Detail Report - RAC Inventory</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        padding: 20px;
      }

      .page-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      /* Filter Section */
      .filter-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
      }

      .filter-row {
        display: flex;
        gap: 15px;
        align-items: flex-end;
        flex-wrap: wrap;
      }

      .filter-group {
        flex: 1;
        min-width: 200px;
      }

      .filter-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 600;
        color: #333;
        font-size: 14px;
      }

      .filter-group input,
      .filter-group select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
      }

      .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 600;
        transition: all 0.3s;
        white-space: nowrap;
      }

      .btn-primary {
        background: #007bff;
        color: white;
      }

      .btn-primary:hover {
        background: #0056b3;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      .btn-info {
        background: #17a2b8;
        color: white;
      }

      .btn-info:hover {
        background: #138496;
      }

      .btn-warning {
        background: #ffc107;
        color: #333;
      }

      .btn-warning:hover {
        background: #e0a800;
      }

      .btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      /* Report Header */
      .report-header {
        border-bottom: 3px solid #000;
        padding-bottom: 20px;
        margin-bottom: 0;
      }

      .company-info {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
      }

      .company-details h1 {
        font-size: 24px;
        margin-bottom: 5px;
        color: #000;
      }

      .company-details p {
        font-size: 12px;
        color: #666;
        line-height: 1.4;
      }

      .company-logo {
        width: 150px;
        height: auto;
      }

      .company-logo img {
        width: 100%;
        height: auto;
        display: block;
      }

      .report-title-section {
        text-align: center;
        margin: 20px 0;
        position: relative;
      }

      .report-title {
        background: #000;
        color: #fff;
        padding: 10px 20px;
        display: inline-block;
        font-size: 20px;
        font-weight: bold;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
      }

      .printed-date {
        position: absolute;
        right: 0;
        top: 10px;
        font-size: 14px;
        color: #000;
      }

      .date-range-subtitle {
        margin-top: 10px;
        font-size: 14px;
        color: #666;
      }

      /* Report Table */
      .report-table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 0;
        margin-top: 20px;
      }

      .report-table thead {
        background: #f8f9fa;
      }

      .report-table th {
        padding: 10px 8px;
        text-align: left;
        font-size: 11px;
        font-weight: 600;
        border-bottom: 2px solid #000;
        white-space: nowrap;
      }

      .report-table td {
        padding: 8px 8px;
        font-size: 11px;
        border-bottom: 1px solid #dee2e6;
        text-align: left;
      }

      .report-table tbody tr:hover {
        background: #f8f9fa;
      }

      /* Totals Row */
      .totals-section {
        margin-top: 0;
      }

      .totals-row {
        border-top: 2px solid #000;
        border-bottom: 2px solid #000;
      }

      .totals-row td {
        font-size: 11px;
        font-weight: bold;
        padding: 10px 8px;
        text-align: left;
      }

      /* Empty State */
      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-state-icon {
        font-size: 48px;
        margin-bottom: 20px;
        opacity: 0.3;
      }

      /* Loading State */
      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Print Styles */
      @media print {
        @page {
          size: A4 landscape;
          margin: 0.5in;
        }

        body {
          background: white;
          padding: 0;
        }
        .page-container {
          box-shadow: none;
          padding: 0;
          max-width: 100%;
        }

        /* Force report content to be visible in print */
        #reportContent {
          display: block !important;
        }

        .filter-section,
        .action-buttons,
        .no-print {
          display: none !important;
        }
        .company-logo img {
          display: block !important;
          -webkit-print-color-adjust: exact;
          print-color-adjust: exact;
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .filter-row {
          flex-direction: column;
        }
        .company-info {
          flex-direction: column;
          gap: 20px;
        }
        .printed-date {
          position: static;
          text-align: center;
          margin-top: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="page-container">
      <!-- Filter Section -->
      <div class="filter-section no-print">
        <div class="filter-row">
          <div class="filter-group">
            <label for="dateFrom">Date From</label>
            <input type="date" id="dateFrom" value="" />
          </div>
          <div class="filter-group">
            <label for="dateTo">Date To</label>
            <input type="date" id="dateTo" value="" />
          </div>
          <div class="filter-group">
            <label for="customerFilter">Customer</label>
            <select id="customerFilter">
              <option value="">All Customers</option>
            </select>
          </div>
          <div class="filter-group">
            <label for="productFilter">Product</label>
            <select id="productFilter">
              <option value="">All Products</option>
            </select>
          </div>
        </div>
        <div class="action-buttons" style="margin-top: 15px">
          <button class="btn btn-primary" onclick="generateReport()">
            üìä Generate Report
          </button>
          <button class="btn btn-success" onclick="printReport()">
            üñ®Ô∏è Print
          </button>
          <button class="btn btn-info" onclick="downloadReportPDF()">
            üì• Download Report PDF
          </button>
          <button
            class="btn btn-warning"
            id="downloadZipBtn"
            onclick="downloadReportWithDockets()"
          >
            üì¶ Download Report + All Dockets
          </button>
          <button
            class="btn btn-success"
            id="emailReportBtn"
            onclick="emailAccountDetailReport()"
            style="display: none"
          >
            üìß Email Report
          </button>
        </div>
      </div>
      <!-- END Filter Section -->

      <!-- Report Content -->
      <div id="reportContent" style="display: none">
        <!-- Company Header -->
        <div class="report-header">
          <div class="company-info">
            <div class="company-details">
              <h1>Rirratjingu Mining Pty Ltd</h1>
              <p>Melville Rd, Nhulunbuy NT 0881</p>
              <p>Ph. 08 8987 3433</p>
              <p>Fax 08 8987 2304</p>
              <p>ABN 15 129 907 660</p>
            </div>
            <div class="company-logo">
              <img src="/RAC_Mining_Logo.png.png" alt="RAC Mining Logo" />
            </div>
          </div>

          <div class="report-title-section">
            <div class="printed-date">
              <strong>Printed on:</strong> <span id="reportDate">-</span>
            </div>
            <div class="report-title">Account Detail Report</div>
            <div class="date-range-subtitle">
              Completed Dockets for: <span id="dateRange">-</span>
            </div>
          </div>
        </div>

        <!-- Report Table -->
        <table class="report-table">
          <thead>
            <tr>
              <th>Account</th>
              <th>Date</th>
              <th>Docket #</th>
              <th>Rego</th>
              <th>Product</th>
              <th>Destination</th>
              <th>Net Wt</th>
              <th>Fee</th>
              <th>Delivery</th>
              <th>GST</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody id="reportTableBody"></tbody>
          <tfoot>
            <tr class="totals-row">
              <td colspan="6">Grand Total</td>
              <td id="totalNetWeight">0 t</td>
              <td id="totalFee">$0.00</td>
              <td id="totalDelivery">$0.00</td>
              <td id="totalGST">$0.00</td>
              <td id="grandTotal">$0.00</td>
            </tr>
          </tfoot>
        </table>

      <!-- Empty State -->
      <div id="emptyState" class="empty-state" style="display: none">
        <div class="empty-state-icon">üìã</div>
        <h3>No Data Available</h3>
        <p>Select date range and filters, then click "Generate Report"</p>
      </div>

      <!-- Loading State -->
      <div id="loadingState" class="loading" style="display: none">
        <div class="spinner"></div>
        <p>Loading report data...</p>
      </div>
    </div>

    <script>
      const API_BASE_URL = "/api";
      let currentReportData = null; // Store current report data for downloads
      let customerEmailData = null; // Store customer email/CC for email feature

      document.addEventListener("DOMContentLoaded", function () {
        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById("dateFrom").valueAsDate = today;
        document.getElementById("dateTo").valueAsDate = today;
        loadCustomers();
        loadProducts();
        showEmptyState();
      });

      async function loadCustomers() {
        try {
          const response = await fetch(`${API_BASE_URL}/customers`);
          const customers = await response.json();
          const select = document.getElementById("customerFilter");
          customers.forEach((customer) => {
            const option = document.createElement("option");
            option.value = customer.customer_id;
            option.textContent = customer.customer_name;
            // Store email data as data attributes
            option.dataset.email = customer.email || "";
            option.dataset.emailCc = customer.email_cc || "";
            select.appendChild(option);
          });

          // Listen for customer selection changes
          select.addEventListener("change", function () {
            const selectedOption = this.options[this.selectedIndex];
            if (selectedOption.value) {
              customerEmailData = {
                customerId: selectedOption.value,
                customerName: selectedOption.textContent,
                email: selectedOption.dataset.email || "",
                emailCc: selectedOption.dataset.emailCc || "",
              };
            } else {
              customerEmailData = null;
            }
          });
        } catch (error) {
          console.error("Error loading customers:", error);
        }
      }

      async function loadProducts() {
        try {
          const response = await fetch(`${API_BASE_URL}/products`);
          const products = await response.json();
          const select = document.getElementById("productFilter");
          products.forEach((product) => {
            const option = document.createElement("option");
            option.value = product.product_id;
            option.textContent = product.product_name;
            select.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading products:", error);
        }
      }

      async function generateReport() {
        const dateFrom = document.getElementById("dateFrom").value;
        const dateTo = document.getElementById("dateTo").value;
        const customerId = document.getElementById("customerFilter").value;
        const productId = document.getElementById("productFilter").value;

        if (!dateFrom || !dateTo) {
          alert("Please select date range");
          return;
        }

        showLoading();

        try {
          const params = new URLSearchParams({
            dateFrom,
            dateTo,
            ...(customerId && { customerId }),
            ...(productId && { productId }),
          });

          const response = await fetch(
            `${API_BASE_URL}/reports/account-detail?${params}`
          );
          const data = await response.json();

          if (data.dockets && data.dockets.length > 0) {
            currentReportData = data; // Store for downloads
            displayReport(data);
          } else {
            currentReportData = null;
            showEmptyState();
          }
        } catch (error) {
          console.error("Error generating report:", error);
          alert("Error generating report. Please try again.");
          currentReportData = null;
          showEmptyState();
        }
      }

      function displayReport(data) {
        document.getElementById("reportDate").textContent =
          new Date().toLocaleDateString("en-AU");

        const dateFrom = document.getElementById("dateFrom").value;
        const dateTo = document.getElementById("dateTo").value;
        document.getElementById("dateRange").textContent = `${formatDate(
          dateFrom
        )} to ${formatDate(dateTo)}`;

        const tbody = document.getElementById("reportTableBody");
        tbody.innerHTML = "";

     let totalNetWt = 0,
          totalFee = 0,
          totalDelivery = 0,
          totalGST = 0,
          totalAmount = 0;

        data.dockets.forEach((docket) => {
          const row = document.createElement("tr");
          const netWt = parseFloat(docket.net_weight) || 0;
          const fee = parseFloat(docket.fee) || 0;
          const deliveryFee = parseFloat(docket.delivery_fee) || 0;
          const gst = parseFloat(docket.gst) || 0;
          const total = parseFloat(docket.total) || 0;

          row.innerHTML = `
            <td>${docket.account || "-"}</td>
            <td>${formatDate(docket.movement_date)} ${formatTime(
            docket.movement_date
          )}</td>
            <td>${docket.docket_no}</td>
            <td>${docket.rego || "-"}</td>
            <td>${docket.product_name}</td>
            <td>${docket.destination || "-"}</td>
            <td>${netWt.toFixed(2)} t</td>
            <td>$${fee.toFixed(2)}</td>
            <td>$${deliveryFee.toFixed(2)}</td>
            <td>$${gst.toFixed(2)}</td>
            <td>$${total.toFixed(2)}</td>
          `;
          tbody.appendChild(row);

          totalNetWt += netWt;
          totalFee += fee;
          totalDelivery += deliveryFee;
          totalGST += gst;
          totalAmount += total;
        });

        document.getElementById(
          "totalNetWeight"
        ).textContent = `${totalNetWt.toFixed(1)} t`;
        document.getElementById("totalFee").textContent = `$${totalFee.toFixed(
          2
        )}`;
        document.getElementById("totalDelivery").textContent = `$${totalDelivery.toFixed(
          2
        )}`;
        document.getElementById("totalGST").textContent = `$${totalGST.toFixed(
          2
        )}`;
        document.getElementById(
          "grandTotal"
        ).textContent = `$${totalAmount.toFixed(2)}`;

        // Show email button only if customer selected
        const emailBtn = document.getElementById("emailReportBtn");
        if (customerEmailData && customerEmailData.customerId) {
          emailBtn.style.display = "inline-block";
        } else {
          emailBtn.style.display = "none";
        }
        showReport();
      }

      function printReport() {
        const reportContent = document.getElementById("reportContent");
        if (reportContent.style.display === "none") {
          alert("Please generate a report first");
          return;
        }
        window.print();
      }

      function downloadReportPDF() {
        if (!currentReportData) {
          alert("Please generate a report first");
          return;
        }

        const dateFrom = document.getElementById("dateFrom").value;
        const dateTo = document.getElementById("dateTo").value;
        const customerId = document.getElementById("customerFilter").value;
        const productId = document.getElementById("productFilter").value;

        const params = new URLSearchParams({
          dateFrom,
          dateTo,
          ...(customerId && { customerId }),
          ...(productId && { productId }),
        });

        // Open PDF in new window/download
        window.open(
          `${API_BASE_URL}/reports/account-detail/pdf?${params}`,
          "_blank"
        );
      }

      function downloadReportWithDockets() {
        if (!currentReportData) {
          alert("Please generate a report first");
          return;
        }

        const downloadBtn = document.getElementById("downloadZipBtn");
        const originalText = downloadBtn.innerHTML;

        // Disable button and show loading
        downloadBtn.disabled = true;
        downloadBtn.innerHTML = "‚è≥ Generating ZIP...";

        const dateFrom = document.getElementById("dateFrom").value;
        const dateTo = document.getElementById("dateTo").value;
        const customerId = document.getElementById("customerFilter").value;
        const productId = document.getElementById("productFilter").value;

        const params = new URLSearchParams({
          dateFrom,
          dateTo,
          ...(customerId && { customerId }),
          ...(productId && { productId }),
        });

        // Create a hidden link and trigger download
        const link = document.createElement("a");
        link.href = `${API_BASE_URL}/reports/account-detail/pdf-with-dockets?${params}`;
        link.download = `Account_Detail_Report_${dateFrom}_to_${dateTo}.zip`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        // Re-enable button after a delay
        setTimeout(() => {
          downloadBtn.disabled = false;
          downloadBtn.innerHTML = originalText;
        }, 3000);
      }

      function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString("en-AU", {
          day: "2-digit",
          month: "short",
          year: "numeric",
        });
      }

      function formatTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleTimeString("en-AU", {
          hour: "2-digit",
          minute: "2-digit",
          hour12: false,
        });
      }

      function showReport() {
        document.getElementById("reportContent").style.display = "block";
        document.getElementById("emptyState").style.display = "none";
        document.getElementById("loadingState").style.display = "none";
      }

      function showEmptyState() {
        document.getElementById("reportContent").style.display = "none";
        document.getElementById("emptyState").style.display = "block";
        document.getElementById("loadingState").style.display = "none";
      }

      function showLoading() {
        document.getElementById("reportContent").style.display = "none";
        document.getElementById("emptyState").style.display = "none";
        document.getElementById("loadingState").style.display = "block";
      }

      async function emailAccountDetailReport() {
        if (!currentReportData) {
          alert("Please generate a report first");
          return;
        }

        if (!customerEmailData || !customerEmailData.customerId) {
          alert("Please select a customer to email the report");
          return;
        }

        // Get defaults from customer record
        const defaultEmail = customerEmailData.email || "";
        const defaultCcEmail = customerEmailData.emailCc || "";

        // ALWAYS prompt - with pre-filled value
        let customerEmail = prompt(
          "Enter recipient email address for Account Detail Report:\n\n(Pre-filled from customer record - you can edit if needed)",
          defaultEmail
        );

        // If user cancelled or left empty
        if (!customerEmail || customerEmail.trim() === "") {
          return;
        }

        customerEmail = customerEmail.trim();

        // Debug: Log the email value
        console.log("DEBUG - Email to validate:", customerEmail);
        console.log("DEBUG - Email length:", customerEmail.length);
        console.log(
          "DEBUG - Email charCodes:",
          Array.from(customerEmail).map((c) => c.charCodeAt(0))
        );

        // Basic email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(customerEmail)) {
          alert(
            "Invalid email address. Please try again.\n\nEmail received: '" +
              customerEmail +
              "'"
          );
          return;
        }

        // Prompt for CC email
        let ccEmail = prompt(
          "Enter CC email address (optional):\n\n(Pre-filled from customer record - you can edit or leave blank)",
          defaultCcEmail
        );

        // If user cancelled CC prompt, set to empty
        if (ccEmail === null) {
          ccEmail = "";
        } else {
          ccEmail = ccEmail.trim();
        }

        // Validate CC email if provided
        if (ccEmail && !emailRegex.test(ccEmail)) {
          alert("Invalid CC email address. Sending without CC.");
          ccEmail = "";
        }

        // Get date range for confirmation
        const dateFrom = document.getElementById("dateFrom").value;
        const dateTo = document.getElementById("dateTo").value;

        // Build confirmation message
        let confirmMsg = `Send Account Detail Report to:\n\nCustomer: ${
          customerEmailData.customerName
        }\nDate Range: ${formatDate(dateFrom)} to ${formatDate(
          dateTo
        )}\n\nTo: ${customerEmail}`;
        if (ccEmail) {
          confirmMsg += `\nCC: ${ccEmail}`;
        }
        confirmMsg +=
          "\n\nThis will include the report PDF and all individual docket PDFs in a ZIP file.\n\nProceed?";

        if (!confirm(confirmMsg)) {
          return;
        }

        // Show loading
        const emailBtn = document.getElementById("emailReportBtn");
        const originalText = emailBtn.innerHTML;
        emailBtn.disabled = true;
        emailBtn.innerHTML = "‚è≥ Sending...";

        try {
          const customerId = document.getElementById("customerFilter").value;
          const productId = document.getElementById("productFilter").value;

          const response = await fetch(
            `${API_BASE_URL}/reports/account-detail/email`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                dateFrom,
                dateTo,
                customerId,
                productId,
                recipientEmail: customerEmail,
                ccEmail: ccEmail || null,
                customerName: customerEmailData.customerName,
              }),
            }
          );

          const data = await response.json();

          if (data.success) {
            let successMsg = `‚úÖ Account Detail Report emailed successfully to ${customerEmail}`;
            if (ccEmail) {
              successMsg += `\nCC: ${ccEmail}`;
            }
            successMsg += `\n\nZIP file contained:\n- Account Detail Report PDF\n- ${
              data.docketCount || 0
            } Weighbridge Docket PDFs`;
            alert(successMsg);
          } else {
            alert(`‚ùå Error sending email: ${data.message}`);
          }
        } catch (error) {
          console.error("Error emailing report:", error);
          alert("‚ùå Error sending email. Please try again.");
        } finally {
          // Reset button
          emailBtn.disabled = false;
          emailBtn.innerHTML = originalText;
        }
      }
    </script>
  </body>
</html>
