<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - RAC Inventory System</title>
    <link rel="stylesheet" href="/css/styles.css" />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo">üì¶</div>
          <div class="site-title">
            <h1>Rirratjingu Mining Inventory System</h1>
            <p>Quarry production and inventory management</p>
          </div>
        </div>
        <div class="header-stats">
          <div class="stat-item">
            <div class="stat-label">Total Inventory Value</div>
            <div class="stat-value" id="totalValue">$0</div>
          </div>
          <div class="user-info">
            <span>üë§</span>
            <span>Admin User</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
      <div class="nav-content">
        <a href="dashboard.html" class="nav-item active">üìä Dashboard</a>
        <a href="operations.html" class="nav-item">‚öôÔ∏è Operations</a>
        <a href="maintenance.html" class="nav-item">üîß Maintenance</a>
        <a href="reports.html" class="nav-item">üìà Reports</a>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
      <!-- Stats Grid -->
      <div class="stats-grid">
        <div class="stat-card primary">
          <div class="stat-card-header">
            <div class="stat-card-title">Products with Stock</div>
            <div class="stat-card-icon">üì¶</div>
          </div>
          <div class="stat-card-value" id="productsCount">-</div>
        </div>

        <div class="stat-card success">
          <div class="stat-card-header">
            <div class="stat-card-title">Inventory Value</div>
            <div class="stat-card-icon">üí∞</div>
          </div>
          <div class="stat-card-value" id="inventoryValue">-</div>
        </div>

        <div class="stat-card warning">
          <div class="stat-card-header">
            <div class="stat-card-title">MTD Production</div>
            <div class="stat-card-icon">üìà</div>
          </div>
          <div class="stat-card-value" id="mtdProduction">-</div>
        </div>

        <div class="stat-card info">
          <div class="stat-card-header">
            <div class="stat-card-title">MTD Sales</div>
            <div class="stat-card-icon">üìâ</div>
          </div>
          <div class="stat-card-value" id="mtdSales">-</div>
        </div>
      </div>

      <!-- Real-Time Stock Overview -->
      <div class="data-table">
        <div class="table-header">
          <h2 class="table-title">Real-Time Stock Overview</h2>
          <div class="table-actions">
            <input
              type="text"
              class="search-box"
              id="searchStock"
              placeholder="Search products..."
            />
            <button class="btn btn-secondary btn-sm" onclick="refreshStock()">
              üîÑ Refresh
            </button>
          </div>
        </div>

        <div id="stockTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading stock data...</p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Format currency
      function formatCurrency(value) {
        return new Intl.NumberFormat("en-AU", {
          style: "currency",
          currency: "AUD",
          minimumFractionDigits: 0,
        }).format(value);
      }

      // Format number with commas
      function formatNumber(value) {
        return new Intl.NumberFormat("en-AU", {
          minimumFractionDigits: 1,
          maximumFractionDigits: 1,
        }).format(value);
      }

      // Load dashboard summary
      async function loadDashboardSummary() {
        try {
          const response = await fetch("/api/stock/summary");
          const data = await response.json();

          document.getElementById("productsCount").textContent =
            data.products_with_stock || 0;
          document.getElementById("inventoryValue").textContent =
            formatCurrency(data.total_inventory_value || 0);
          document.getElementById("totalValue").textContent = formatCurrency(
            data.total_inventory_value || 0
          );
        } catch (error) {
          console.error("Error loading summary:", error);
        }
      }

      // Load today's movements (MTD)
      async function loadTodayMovements() {
        try {
          const response = await fetch("/api/movements/today");
          const data = await response.json();

          const production = data.find((d) => d.movement_type === "PRODUCTION");
          const sales = data.find((d) => d.movement_type === "SALES");

          document.getElementById("mtdProduction").textContent = production
            ? formatNumber(production.total_quantity) + "t"
            : "0.0t";
          document.getElementById("mtdSales").textContent = sales
            ? formatNumber(Math.abs(sales.total_quantity)) + "t"
            : "0.0t";
        } catch (error) {
          console.error("Error loading movements:", error);
          document.getElementById("mtdProduction").textContent = "0.0t";
          document.getElementById("mtdSales").textContent = "0.0t";
        }
      }

      // Load current stock
      async function loadCurrentStock() {
        try {
          const response = await fetch("/api/stock/current");
          const stock = await response.json();

          const container = document.getElementById("stockTableContainer");

          if (stock.length === 0) {
            container.innerHTML =
              '<div class="loading"><p>No stock data available</p></div>';
            return;
          }

          let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Location</th>
                                <th>Stock Level</th>
                                <th>Avg Cost</th>
                                <th>Total Value</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

          stock.forEach((item) => {
            const statusClass =
              item.status === "LOW"
                ? "badge-danger"
                : item.status === "HIGH"
                ? "badge-warning"
                : "badge-normal";

            html += `
                        <tr>
                            <td>
                                <strong style="color: var(--gray-900);">${
                                  item.product_name
                                }</strong><br>
                                <small style="color: var(--gray-500); text-transform: uppercase;">${
                                  item.family_group
                                }</small>
                            </td>
                            <td>${item.location_name}</td>
                            <td><strong style="color: var(--success-color);">${formatNumber(
                              item.quantity
                            )}</strong></td>
                            <td>${formatCurrency(item.average_cost)}</td>
                            <td><strong>${formatCurrency(
                              item.total_value
                            )}</strong></td>
                            <td><span class="badge ${statusClass}">${
              item.status
            }</span></td>
                        </tr>
                    `;
          });

          html += "</tbody></table>";
          container.innerHTML = html;

          // Add search functionality
          const searchBox = document.getElementById("searchStock");
          searchBox.addEventListener("input", filterStock);
        } catch (error) {
          console.error("Error loading stock:", error);
          document.getElementById("stockTableContainer").innerHTML =
            '<div class="loading"><p>Error loading stock data</p></div>';
        }
      }

      // Filter stock table
      function filterStock() {
        const searchTerm = document
          .getElementById("searchStock")
          .value.toLowerCase();
        const rows = document.querySelectorAll("#stockTableContainer tbody tr");

        rows.forEach((row) => {
          const text = row.textContent.toLowerCase();
          row.style.display = text.includes(searchTerm) ? "" : "none";
        });
      }

      // Refresh stock
      function refreshStock() {
        document.getElementById("stockTableContainer").innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Refreshing...</p>
                </div>
            `;
        loadCurrentStock();
        loadDashboardSummary();
        loadTodayMovements();
      }

      // Initialize dashboard
      document.addEventListener("DOMContentLoaded", () => {
        loadDashboardSummary();
        loadTodayMovements();
        loadCurrentStock();
      });
    </script>
  </body>
</html>
