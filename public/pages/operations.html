<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Operations - RAC Inventory System</title>
    <link rel="stylesheet" href="/css/styles.css" />
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="logo-section">
          <div class="logo">üì¶</div>
          <div class="site-title">
            <h1>Rirratjingu Mining Inventory System</h1>
            <p>Quarry production and inventory management</p>
          </div>
        </div>
        <div class="header-stats">
          <div class="stat-item">
            <div class="stat-label">Total Inventory Value</div>
            <div class="stat-value" id="totalValue">$0</div>
          </div>
          <div class="user-info">
            <span>üë§</span>
            <span>Admin User</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Navigation -->
    <nav class="nav">
      <div class="nav-content">
        <a href="dashboard.html" class="nav-item">üìä Dashboard</a>
        <a href="operations.html" class="nav-item active">‚öôÔ∏è Operations</a>
        <a href="maintenance.html" class="nav-item">üîß Maintenance</a>
        <a href="reports.html" class="nav-item">üìà Reports</a>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
      <div class="page-header">
        <h1 class="page-title">Quarry Operations</h1>
        <p class="page-subtitle">
          Record daily production and sales activities
        </p>
      </div>

      <!-- Action Cards -->
      <div class="action-cards">
        <div class="action-card primary" onclick="openProductionModal()">
          <div class="action-card-icon">üì¶</div>
          <div class="action-card-title">Production Entry</div>
          <div class="action-card-description">
            Record daily production from extraction to stockpiles
          </div>
        </div>

        <div class="action-card demand" onclick="openDemandModal()">
          <div class="action-card-icon">üìã</div>
          <div class="action-card-title">Demand Entry</div>
          <div class="action-card-description">
            Record future orders and demand forecasts
          </div>
        </div>

        <div class="action-card success" onclick="openSalesModal()">
          <div class="action-card-icon">üí∞</div>
          <div class="action-card-title">Sales Entry</div>
          <div class="action-card-description">
            Record customer sales and deliveries
          </div>
        </div>

        <div
          class="action-card info"
          onclick="window.location.href='stocktake.html'"
        >
          <div class="action-card-icon">üìä</div>
          <div class="action-card-title">Stocktake</div>
          <div class="action-card-description">
            Adjust inventory to match physical stocktake
          </div>
        </div>

        <div class="action-card warning" onclick="openAdjustmentModal()">
          <div class="action-card-icon">‚öñÔ∏è</div>
          <div class="action-card-title">Stock Adjustment</div>
          <div class="action-card-description">
            Adjust stock levels or transfer between locations
          </div>
        </div>

        <div class="action-card info" onclick="openTareWeightModal()">
          <div class="action-card-icon">üöõ</div>
          <div class="action-card-title">Record Tare Weight</div>
          <div class="action-card-description">
            Register incoming truck tare weights at weighbridge
          </div>
        </div>
      </div>

      <!-- Stats Row -->
      <div class="stats-grid">
        <div class="stat-card primary">
          <div class="stat-card-header">
            <div class="stat-card-title">Today's Production</div>
            <div class="stat-card-icon">üìà</div>
          </div>
          <div class="stat-card-value" id="todayProduction">0.0 tonnes</div>
        </div>

        <div class="stat-card info">
          <div class="stat-card-header">
            <div class="stat-card-title">Today's Sales</div>
            <div class="stat-card-icon">üí∞</div>
          </div>
          <div class="stat-card-value" id="todaySales">0.0 tonnes</div>
        </div>

        <div class="stat-card success">
          <div class="stat-card-header">
            <div class="stat-card-title">Active Vehicles</div>
            <div class="stat-card-icon">üöõ</div>
          </div>
          <div class="stat-card-value" id="activeVehicles">-</div>
        </div>

        <div class="stat-card warning">
          <div class="stat-card-header">
            <div class="stat-card-title">Active Operators</div>
            <div class="stat-card-icon">üë∑</div>
          </div>
          <div class="stat-card-value" id="activeOperators">-</div>
        </div>
      </div>

      <!-- Recent Movements -->
      <div class="data-table">
        <div class="table-header">
          <h2 class="table-title">Recent Movements</h2>
          <div
            class="table-actions"
            style="display: flex; gap: 10px; align-items: center"
          >
            <!-- Customer Filter -->
            <select
              class="form-control"
              id="customerFilter"
              onchange="filterMovements()"
              style="width: 200px; padding: 8px"
            >
              <option value="">All Customers</option>
            </select>

            <!-- Type Filter -->
            <select
              class="form-control"
              id="typeFilter"
              onchange="filterMovements()"
              style="width: 150px; padding: 8px"
            >
              <option value="">All Types</option>
              <option value="PRODUCTION">Production</option>
              <option value="SALES">Sales</option>
              <option value="DEMAND">Demand</option>
              <option value="ADJUSTMENT">Adjustment</option>
            </select>

            <!-- Search Box -->
            <input
              type="text"
              class="search-box"
              id="searchMovements"
              placeholder="Search..."
              onkeyup="filterMovements()"
              style="width: 180px; padding: 8px"
            />

            <!-- Refresh Button -->
            <button
              class="btn btn-secondary btn-sm"
              onclick="refreshMovements()"
            >
              üîÑ Refresh
            </button>
          </div>
        </div>

        <div id="movementsTableContainer">
          <div class="loading">
            <div class="spinner"></div>
            <p>Loading movements...</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Production Modal -->
    <div id="productionModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Production Entry</h2>
          <button class="modal-close" onclick="closeProductionModal()">
            √ó
          </button>
        </div>
        <form
          id="productionForm"
          onsubmit="event.preventDefault(); saveProduction();"
        >
          <!-- Production form fields -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label required">Production Date</label>
              <input
                type="date"
                class="form-control"
                id="productionDate"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label required">Product</label>
              <select class="form-control" id="productionProduct" required>
                <option value="">Select Product</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label required">To Stockpile</label>
              <select class="form-control" id="productionLocation" required>
                <option value="">Select Stockpile</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label required">Quantity (tonnes)</label>
              <input
                type="number"
                class="form-control"
                id="productionQuantity"
                step="0.01"
                required
              />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label required">Cost per Tonne ($)</label>
            <input
              type="number"
              class="form-control"
              id="productionCost"
              step="0.01"
              required
            />
          </div>

          <div class="form-group">
            <label class="form-label">Operator</label>
            <select class="form-control" id="productionOperator">
              <option value="">Select Operator</option>
            </select>
          </div>

          <div class="form-group">
            <label class="form-label">Reference</label>
            <input
              type="text"
              class="form-control"
              id="productionReference"
              placeholder="e.g., PROD_001"
            />
          </div>

          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea
              class="form-control"
              id="productionNotes"
              rows="3"
              placeholder="Production notes..."
            ></textarea>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeProductionModal()"
            >
              Cancel
            </button>
            <button type="submit" class="btn-primary">
              üíæ Save Production
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Demand Modal -->
    <div id="demandModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Demand Entry</h2>
          <button class="modal-close" onclick="closeDemandModal()">√ó</button>
        </div>
        <form id="demandForm" onsubmit="event.preventDefault(); saveDemand();">
          <div class="form-row">
            <div class="form-group">
              <label class="form-label required">Future Sale Date</label>
              <input
                type="date"
                class="form-control"
                id="demandDate"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label required">Product</label>
              <select class="form-control" id="demandProduct" required>
                <option value="">Select Product</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label required"
                >Demand Quantity (tonnes)</label
              >
              <input
                type="number"
                class="form-control"
                id="demandQuantity"
                step="0.01"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label required">Customer</label>
              <select class="form-control" id="demandCustomer" required>
                <option value="">Select Customer</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label required">PO Number</label>
              <input
                type="text"
                class="form-control"
                id="demandPO"
                required
                placeholder="e.g., PO-2025-001"
              />
            </div>
            <div class="form-group">
              <label class="form-label">Demand Reference</label>
              <input
                type="text"
                class="form-control"
                id="demandReference"
                placeholder="e.g., DEMAND-001"
              />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea
              class="form-control"
              id="demandNotes"
              rows="3"
              placeholder="Delivery instructions, special requirements, etc."
            ></textarea>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeDemandModal()"
            >
              Cancel
            </button>
            <button type="submit" class="btn-demand">üìã Save Demand</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Sales Modal -->
    <div id="salesModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Sales Entry</h2>
          <button class="modal-close" onclick="closeSalesModal()">√ó</button>
        </div>
        <form id="salesForm" onsubmit="event.preventDefault(); saveSales();">
          <!-- Sales form fields -->
          <div class="form-row">
            <div class="form-group">
              <label class="form-label required">Sale Date</label>
              <input type="date" class="form-control" id="saleDate" required />
            </div>
            <div class="form-group">
              <label class="form-label required">Product Sold</label>
              <select
                class="form-control"
                id="saleProduct"
                required
                onchange="updateSalePrice()"
              >
                <option value="">Select Product Sold</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label required">From Stockpile</label>
              <select class="form-control" id="saleLocation" required>
                <option value="">Select From Stockpile</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label required">Gross Weight (tonnes)</label>
              <input
                type="number"
                class="form-control"
                id="saleGrossWeight"
                step="0.01"
                required
                oninput="calculateNetWeight()"
                placeholder="e.g., 100.0"
              />
              <small style="color: #666"
                >Total weight on weighbridge (loaded truck)</small
              >
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label required">Tare Weight (tonnes)</label>
              <input
                type="number"
                class="form-control"
                id="saleTareWeight"
                step="0.01"
                required
                oninput="calculateNetWeight()"
                placeholder="e.g., 20.0"
              />
              <small style="color: #666">Empty truck weight</small>
            </div>

            <div class="form-group">
              <label class="form-label">Net Weight (tonnes)</label>
              <input
                type="number"
                class="form-control"
                id="saleNetWeight"
                step="0.01"
                readonly
                style="
                  background-color: #f0f0f0;
                  font-weight: bold;
                  color: #28a745;
                "
                placeholder="Auto-calculated"
              />
              <small style="color: #666"
                >Gross - Tare = Net (actual product sold)</small
              >
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label class="form-label required"
                >Sale Price per Tonne ($)</label
              >
              <input
                type="number"
                class="form-control"
                id="salePrice"
                step="0.01"
                required
                placeholder="Auto-filled from product"
              />
            </div>
            <div class="form-group">
              <label class="form-label required">Customer</label>
              <select class="form-control" id="saleCustomer" required>
                <option value="">Select Customer</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Delivery Vehicle</label>
              <select class="form-control" id="saleVehicle">
                <option value="">Select Vehicle</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Driver</label>
              <select class="form-control" id="saleDriver">
                <option value="">Select Driver</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Carrier</label>
            <select class="form-control" id="saleCarrier">
              <option value="">Select Carrier</option>
            </select>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Delivery Type</label>
              <select class="form-control" id="saleDelivery">
                <option value="">Select Delivery Type</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Sale Reference</label>
              <input
                type="text"
                class="form-control"
                id="saleReference"
                placeholder="e.g., SALE-001"
              />
            </div>
            <div class="form-group">
              <label class="form-label"
                >Docket Number
                <span style="color: #28a745">(Auto-assigned)</span></label
              >
              <input
                type="text"
                class="form-control"
                value="Will be auto-assigned as DN00001, DN00002, etc."
                readonly
                style="background-color: #f0f0f0; color: #666"
              />
            </div>
          </div>

          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea
              class="form-control"
              id="saleNotes"
              rows="3"
              placeholder="Delivery instructions, special requirements, etc."
            ></textarea>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeSalesModal()"
            >
              Cancel
            </button>
            <button type="submit" class="btn-success">üí∞ Save Sales</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Stock Adjustment Modal -->
    <div id="adjustmentModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Stock Adjustment / Transfer</h2>
          <button class="modal-close" onclick="closeAdjustmentModal()">
            √ó
          </button>
        </div>
        <form
          id="adjustmentForm"
          onsubmit="event.preventDefault(); saveAdjustment();"
        >
          <div class="form-row">
            <div class="form-group">
              <label class="form-label required">Date</label>
              <input
                type="date"
                class="form-control"
                id="adjustmentDate"
                required
              />
            </div>
            <div class="form-group">
              <label class="form-label required">Type</label>
              <select
                class="form-control"
                id="adjustmentType"
                required
                onchange="toggleAdjustmentType()"
              >
                <option value="">Select Type</option>
                <option value="ADJUSTMENT">Adjustment</option>
                <option value="TRANSFER">Transfer</option>
              </select>
            </div>
          </div>

          <!-- ADJUSTMENT FIELDS -->
          <div id="adjustmentFields" style="display: none">
            <div class="form-row">
              <div class="form-group">
                <label class="form-label required">Product</label>
                <select class="form-control" id="adjustmentProduct">
                  <option value="">Select Product</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label required">Location</label>
                <select class="form-control" id="adjustmentLocation">
                  <option value="">Select Location</option>
                </select>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label required"
                  >Adjustment Quantity (tonnes)</label
                >
                <input
                  type="number"
                  class="form-control"
                  id="adjustmentQuantity"
                  step="0.01"
                  placeholder="Use + or - (e.g., -50 or +100)"
                />
                <small style="color: #666"
                  >Negative to reduce stock, positive to increase</small
                >
              </div>
              <div class="form-group">
                <label class="form-label required">Reason</label>
                <select class="form-control" id="adjustmentReason">
                  <option value="">Select Reason</option>
                  <option value="Sales Overage">Sales Overage</option>
                  <option value="Stocktake Correction">
                    Stocktake Correction
                  </option>
                  <option value="Shrinkage">Shrinkage</option>
                  <option value="Damage">Damage</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>
          </div>

          <!-- TRANSFER FIELDS -->
          <div id="transferFields" style="display: none">
            <div class="form-group">
              <label class="form-label required">Product</label>
              <select
                class="form-control"
                id="transferProduct"
                onchange="loadTransferLocations()"
              >
                <option value="">Select Product</option>
              </select>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label class="form-label required">From Location</label>
                <select class="form-control" id="transferFromLocation">
                  <option value="">Select From Location</option>
                </select>
              </div>
              <div class="form-group">
                <label class="form-label required">To Location</label>
                <select class="form-control" id="transferToLocation">
                  <option value="">Select To Location</option>
                </select>
              </div>
            </div>

            <div class="form-group">
              <label class="form-label required"
                >Transfer Quantity (tonnes)</label
              >
              <input
                type="number"
                class="form-control"
                id="transferQuantity"
                step="0.01"
                min="0.01"
                placeholder="e.g., 50.5"
              />
              <small style="color: #666"
                >Always positive - moving from one location to another</small
              >
            </div>
          </div>

          <!-- COMMON FIELDS -->
          <div class="form-group">
            <label class="form-label">Reference</label>
            <input
              type="text"
              class="form-control"
              id="adjustmentReference"
              placeholder="e.g., ADJ-001 or TRF-001"
            />
          </div>

          <div class="form-group">
            <label class="form-label">Notes</label>
            <textarea
              class="form-control"
              id="adjustmentNotes"
              rows="3"
              placeholder="Reason for adjustment or transfer details..."
            ></textarea>
          </div>

          <div class="modal-footer">
            <button
              type="button"
              class="btn-secondary"
              onclick="closeAdjustmentModal()"
            >
              Cancel
            </button>
            <button type="submit" class="btn-warning">
              ‚öñÔ∏è Save Adjustment
            </button>
          </div>
        </form>
      </div>
    </div>

    <script src="/js/operations.js"></script>
    <script>
      // Update header inventory value
      async function updateHeaderValue() {
        try {
          const response = await fetch("/api/stock/summary");
          const data = await response.json();
          const totalValue = data.total_inventory_value || 0;
          document.getElementById("totalValue").textContent =
            new Intl.NumberFormat("en-AU", {
              style: "currency",
              currency: "AUD",
              minimumFractionDigits: 0,
            }).format(totalValue);
        } catch (error) {
          console.error("Error loading header value:", error);
        }
      }
      updateHeaderValue();
    </script>
  </body>
</html>
